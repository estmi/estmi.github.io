"use strict";(self.webpackChunkmarkdown_website=self.webpackChunkmarkdown_website||[]).push([[5504],{366:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>d,contentTitle:()=>c,default:()=>o,frontMatter:()=>s,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"clients/Energia Colectiva/243922/index","title":"[243922] Circular 2/2005 ENERG\xcdA COLECTIVA","description":"SQL filtrat per periode T3 i R1-001 i COD_TAR 19","source":"@site/docs/clients/Energia Colectiva/243922/index.md","sourceDirName":"clients/Energia Colectiva/243922","slug":"/clients/Energia Colectiva/243922/","permalink":"/docs/clients/Energia Colectiva/243922/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"clientsSidebar","previous":{"title":"[243837] Procediment ESCILA","permalink":"/docs/clients/Energetica/243837/"},"next":{"title":"CAS 238317","permalink":"/docs/clients/Goufone/238317/"}}');var a=i(4848),r=i(8453);const s={},c="[243922] Circular 2/2005 ENERG\xcdA COLECTIVA",d={},l=[{value:"SQL filtrat per periode T3 i R1-001 i COD_TAR 19",id:"sql-filtrat-per-periode-t3-i-r1-001-i-cod_tar-19",level:2},{value:"Polissa afectada: 318187 (id: 422474)",id:"polissa-afectada-318187-id-422474",level:2},{value:"Dades linies factures",id:"dades-linies-factures",level:3},{value:"Tots els decimals",id:"tots-els-decimals",level:4},{value:"Base ja arrodonida a 2",id:"base-ja-arrodonida-a-2",level:4}];function E(n){const e={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"243922-circular-22005-energ\xeda-colectiva",children:"[243922] Circular 2/2005 ENERG\xcdA COLECTIVA"})}),"\n",(0,a.jsx)(e.h2,{id:"sql-filtrat-per-periode-t3-i-r1-001-i-cod_tar-19",children:"SQL filtrat per periode T3 i R1-001 i COD_TAR 19"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"SELECT\n  aggregation.ANIO_ENVIO,\n  aggregation.TRIMESTRE_ENVIO,\n  aggregation.COD_COM,\n  aggregation.COD_DIS,\n  aggregation.COD_TPM,\n  aggregation.MODO_FACTURACION,\n  (\n    SELECT\n      COUNT(DISTINCT md.polissa_id)\n    FROM\n      giscedata_polissa_modcontractual md\n      INNER JOIN (\n        SELECT\n          CASE\n            WHEN t.name = '2.0A' THEN '01'\n            WHEN t.name = '2.0DHA' THEN '02'\n            WHEN t.name = '3.0A' THEN '03'\n            WHEN t.name = '3.0A LB' THEN '03'\n            WHEN t.name = '3.1A' THEN '04'\n            WHEN t.name = '3.1A LB' THEN '04'\n            WHEN t.name = '6.1' THEN '05'\n            WHEN t.name = '6.1A' THEN '05'\n            WHEN t.name = '6.1B' THEN '17'\n            WHEN t.name = '6.2' THEN '06'\n            WHEN t.name = '6.3' THEN '07'\n            WHEN t.name = '6.4' THEN '08'\n            WHEN t.name = '6.5' THEN '09'\n            WHEN t.name = '2.1A' THEN '10'\n            WHEN t.name = '2.1DHA' THEN '11'\n            WHEN t.name = '2.0DHS' THEN '12'\n            WHEN t.name = '2.1DHS' THEN '13'\n            WHEN t.name = '2.0TD' THEN '18'\n            WHEN t.name = '3.0TD' THEN '19'\n            WHEN t.name = '6.1TD' THEN '20'\n            WHEN t.name = '6.2TD' THEN '21'\n            WHEN t.name = '6.3TD' THEN '22'\n            WHEN t.name = '6.4TD' THEN '23'\n            WHEN t.name = '3.0TDVE' THEN '24'\n            WHEN t.name = '6.1TDVE' THEN '25'\n          END AS codi_tarifa,\n          t.id AS tarifa_id\n        FROM giscedata_polissa_tarifa t\n      ) tarifa ON md.tarifa = tarifa.tarifa_id\n      LEFT JOIN giscedata_polissa pol ON md.polissa_id = pol.id\n      LEFT JOIN res_partner comer ON pol.comercialitzadora = comer.id\n      LEFT JOIN res_partner distri ON md.distribuidora = distri.id\n      JOIN giscedata_cups_ps cups ON md.cups = cups.id\n      JOIN res_municipi mun ON cups.id_municipi = mun.id\n      LEFT JOIN res_country_state cs ON mun.state = cs.id\n    WHERE '2024-09-30' BETWEEN md.data_inici AND md.data_final\n      AND md.agree_tipus = aggregation.COD_TPM\n      AND (\n        distri.ref2 IS NULL OR distri.ref2 = aggregation.COD_DIS\n      )\n      AND comer.ref2 = aggregation.COD_COM\n      AND RPAD(cs.code::text, 5, '0') = aggregation.COD_PRV\n      AND tarifa.codi_tarifa = aggregation.COD_TIPO_TAR_ACCESO\n  ) AS num_sum,\n  aggregation.COD_PRV,\n  aggregation.COD_TIPO_TAR_ACCESO,\n  CASE\n    WHEN aggregation.ENERGIA = 0 THEN 0\n    ELSE round(aggregation.PRE_MED_TAR / ENERGIA, 3)\n  END,\n  CASE\n    WHEN aggregation.ENERGIA = 0 THEN 0\n    ELSE round(aggregation.PRE_MED_SUM / ENERGIA, 3)\n  END,\n  aggregation.ENERGIA\nFROM (\n  SELECT\n    TO_CHAR(DATE('2024-09-30'),'YYYY') AS ANIO_ENVIO,\n    'T3' AS TRIMESTRE_ENVIO,\n    comer.ref2 AS COD_COM,\n    COALESCE(distri.ref2, distri.name) AS COD_DIS,\n    polissa.agree_tipus AS COD_TPM,\n    1 AS MODO_FACTURACION,\n    RPAD(cs.code::text, 5, '0') AS COD_PRV,\n    (\n      SELECT CASE\n        WHEN t.name = '2.0A' THEN '01'\n        WHEN t.name = '2.0DHA' THEN '02'\n        WHEN t.name = '3.0A' THEN '03'\n        WHEN t.name = '3.0A LB' THEN '03'\n        WHEN t.name = '3.1A' THEN '04'\n        WHEN t.name = '3.1A LB' THEN '04'\n        WHEN t.name = '6.1' THEN '05'\n        WHEN t.name = '6.1A' THEN '05'\n        WHEN t.name = '6.1B' THEN '17'\n        WHEN t.name = '6.2' THEN '06'\n        WHEN t.name = '6.3' THEN '07'\n        WHEN t.name = '6.4' THEN '08'\n        WHEN t.name = '6.5' THEN '09'\n        WHEN t.name = '2.1A' THEN '10'\n        WHEN t.name = '2.1DHA' THEN '11'\n        WHEN t.name = '2.0DHS' THEN '12'\n        WHEN t.name = '2.1DHS' THEN '13'\n        WHEN t.name = '2.0TD' THEN '18'\n        WHEN t.name = '3.0TD' THEN '19'\n        WHEN t.name = '6.1TD' THEN '20'\n        WHEN t.name = '6.2TD' THEN '21'\n        WHEN t.name = '6.3TD' THEN '22'\n        WHEN t.name = '6.4TD' THEN '23'\n        WHEN t.name = '3.0TDVE' THEN '24'\n        WHEN t.name = '6.1TDVE' THEN '25'\n      END\n    ) AS COD_TIPO_TAR_ACCESO,\n    COALESCE(SUM(flin.atrprice_subtotal * CASE WHEN inv.type = 'out_refund' THEN -1 ELSE 1 END * 100), 0) AS PRE_MED_TAR,\n\n    COALESCE(SUM((line.price_subtotal - flin.atrprice_subtotal)* CASE WHEN inv.type = 'out_refund' THEN -1 ELSE 1 END * 100), 0) AS PRE_MED_SUM,\n\n    round(sum(COALESCE(\n      CASE WHEN flin.tipus = 'energia' AND line.product_id not in (select id from product_product where default_code in ('RMAG', 'CB'))\n      THEN (CASE WHEN inv.type = 'out_refund' THEN -line.quantity  ELSE line.quantity END)\n      ELSE 0 END, 0\n    )), 0)::int AS ENERGIA\n  FROM\n    giscedata_facturacio_factura fact\n    JOIN giscedata_facturacio_factura_linia flin ON fact.id = flin.factura_id\n    JOIN account_invoice inv ON inv.id = fact.invoice_id\n    JOIN account_invoice_line line ON flin.invoice_line_id = line.id\n    JOIN giscedata_polissa polissa ON polissa.id = fact.polissa_id\n    JOIN giscedata_polissa_tarifa t ON t.id = polissa.tarifa\n    LEFT JOIN res_partner comer ON polissa.comercialitzadora = comer.id\n    LEFT JOIN res_partner distri ON polissa.distribuidora = distri.id\n    JOIN giscedata_cups_ps cups ON polissa.cups = cups.id\n    JOIN res_municipi mun ON cups.id_municipi = mun.id\n    LEFT JOIN res_country_state cs ON mun.state = cs.id\n  WHERE\n    inv.date_invoice BETWEEN '2023-10-01' AND '2024-09-30'\n    AND flin.tipus IN ('energia', 'potencia', 'reactiva', 'exces_potencia')\n    AND inv.type IN ('out_invoice', 'out_refund')\n    AND inv.state NOT IN ('draft', 'cancel', 'proforma')\n    AND fact.energia_kwh != 0\n    AND t.name = '3.0TD'\n    AND COALESCE(distri.ref2, distri.name) = 'R1-001'\n  GROUP BY\n    ANIO_ENVIO, TRIMESTRE_ENVIO, COD_COM, COD_DIS, COD_TPM, MODO_FACTURACION, COD_PRV, COD_TIPO_TAR_ACCESO\n  ORDER BY\n    COD_PRV\n) AS aggregation\nWHERE\n  aggregation.ENERGIA > 0;\n"})}),"\n",(0,a.jsxs)(e.table,{children:[(0,a.jsx)(e.thead,{children:(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.th,{children:"anio_envio"}),(0,a.jsx)(e.th,{children:"trimestre_envio"}),(0,a.jsx)(e.th,{children:"cod_com"}),(0,a.jsx)(e.th,{children:"cod_dis"}),(0,a.jsx)(e.th,{children:"cod_tpm"}),(0,a.jsx)(e.th,{children:"modo_facturacion"}),(0,a.jsx)(e.th,{children:"num_sum"}),(0,a.jsx)(e.th,{children:"cod_prv"}),(0,a.jsx)(e.th,{children:"cod_tipo_tar_acceso"}),(0,a.jsx)(e.th,{children:"round"}),(0,a.jsx)(e.th,{children:"round"}),(0,a.jsx)(e.th,{children:"energia"})]})}),(0,a.jsx)(e.tbody,{children:(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:"2024"}),(0,a.jsx)(e.td,{children:"T3"}),(0,a.jsx)(e.td,{children:"R2-542"}),(0,a.jsx)(e.td,{children:"R1-001"}),(0,a.jsx)(e.td,{children:"04"}),(0,a.jsx)(e.td,{children:"1"}),(0,a.jsx)(e.td,{children:"1"}),(0,a.jsx)(e.td,{children:"28000"}),(0,a.jsx)(e.td,{children:"19"}),(0,a.jsx)(e.td,{children:"1.692"}),(0,a.jsx)(e.td,{children:"13.940"}),(0,a.jsx)(e.td,{children:"53117"})]})})]}),"\n",(0,a.jsx)(e.h2,{id:"polissa-afectada-318187-id-422474",children:"Polissa afectada: 318187 (id: 422474)"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Factures affectades (15): 13812314, 13473559, 13028953, 12628095, 12196013, 11948615, 11623519, 11260499, 10975023, 10668632, 10406839, 10279401, 10060830, 10060829, 9792926"}),"\n"]}),"\n",(0,a.jsx)(e.h3,{id:"dades-linies-factures",children:"Dades linies factures"}),"\n",(0,a.jsx)(e.h4,{id:"tots-els-decimals",children:"Tots els decimals"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"SELECT\n    sum(line.quantity * line.price_unit),\n    sum(flin.atrprice_subtotal),\n    sum((line.quantity * line.price_unit) - flin.atrprice_subtotal) \nFROM giscedata_facturacio_factura fact\nJOIN giscedata_facturacio_factura_linia flin ON fact.id = flin.factura_id\nJOIN account_invoice inv ON inv.id = fact.invoice_id\nJOIN account_invoice_line line ON flin.invoice_line_id = line.id\nWHERE fact.id in (13812314, 13473559, 13028953, 12628095, 12196013, 11948615, 11623519, 11260499, 10975023, 10668632, 10406839, 10279401, 10060830, 10060829, 9792926);\n"})}),"\n",(0,a.jsxs)(e.table,{children:[(0,a.jsx)(e.thead,{children:(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.th,{children:"total linies"}),(0,a.jsx)(e.th,{children:"total peatges"}),(0,a.jsx)(e.th,{children:"total sense peatges"})]})}),(0,a.jsx)(e.tbody,{children:(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:"8246.934574020"}),(0,a.jsx)(e.td,{children:"986.13"}),(0,a.jsx)(e.td,{children:"7260.804574020"})]})})]}),"\n",(0,a.jsx)(e.admonition,{title:"Calcul",type:"info",children:(0,a.jsx)(e.p,{children:"Energia: 53117\nTotal sense peatges: 7260.804574020\nFinal: 726080.4574020 / 53117 = 13.669455304"})}),"\n",(0,a.jsx)(e.h4,{id:"base-ja-arrodonida-a-2",children:"Base ja arrodonida a 2"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"SELECT\n    sum(line.price_subtotal),\n    sum(flin.atrprice_subtotal),\n    sum((line.price_subtotal - flin.atrprice_subtotal))\nFROM giscedata_facturacio_factura fact\nJOIN giscedata_facturacio_factura_linia flin ON fact.id = flin.factura_id\nJOIN account_invoice inv ON inv.id = fact.invoice_id\nJOIN account_invoice_line line ON flin.invoice_line_id = line.id\nWHERE fact.id in (13812314, 13473559, 13028953, 12628095, 12196013, 11948615, 11623519, 11260499, 10975023, 10668632, 10406839, 10279401, 10060830, 10060829, 9792926);\n"})}),"\n",(0,a.jsxs)(e.table,{children:[(0,a.jsx)(e.thead,{children:(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.th,{children:"total linies"}),(0,a.jsx)(e.th,{children:"total peatges"}),(0,a.jsx)(e.th,{children:"total sense peatges"})]})}),(0,a.jsx)(e.tbody,{children:(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:"8246.95"}),(0,a.jsx)(e.td,{children:"986.13"}),(0,a.jsx)(e.td,{children:"7260.82"})]})})]}),"\n",(0,a.jsx)(e.admonition,{title:"Calcul",type:"info",children:(0,a.jsx)(e.p,{children:"Energia: 53117\nTotal sense peatges: 7260.82\nFinal: 7260.82 / 53117 = 13.669455304"})})]})}function o(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(E,{...n})}):E(n)}},8453:(n,e,i)=>{i.d(e,{R:()=>s,x:()=>c});var t=i(6540);const a={},r=t.createContext(a);function s(n){const e=t.useContext(r);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:s(n.components),t.createElement(r.Provider,{value:e},n.children)}}}]);